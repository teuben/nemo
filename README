This is:	A blurb on NEMO V3, what it is, how to install and use 
Last updated:   1-apr-01
By:		Peter Teuben
Disclaimer:	The manual is now out of date, this installation is
		much more based on autoconf

________________________________________________________________________________

(for INSTALLATION instruction see below)

Using NEMO (i.e. when somebody had already installed it for you) requires
just a few changes modifications to your .cshrc/.login script: 
(sorry, no sh support yet)

    1)	source the "nemo_start" file. You may have to ask your system
	manager where it is kept. For example:

		source ~nemo/nemo_start

or the long way:

    1)  define the environment variable NEMO where NEMO's root directory is.
    2)  optionally define NEMOHOST if you want to override an automatic determination
    3)  source the $NEMO/NEMORC file.
    4)  add $NEMOBIN to you search path. Note that in NEMO V3+ the 'cc'
	command is now available, as NEMOBIN/cc has disappeared.

	        setenv NEMO /home/nemo		             (1)
	        source $NEMO/NEMORC			     (3)
	        set path = ( . xxx $NEMOBIN yyy zzz)	     (4)

where xxx, yyy  and zzz are other directories you may want in there. 

Alternatively, you can set up a dynamic NEMO installation, which means
that NEMO is by default not present after you have logged in.  The
dynamic installation requires a special command (normally an alias
'nemo') to be issued in order to ``load'' NEMO into the environment. 
e.g. I use:
	alias nemo 'source ~nemo/nemo_start; unalias nemo'
and the reverse to remove it:
	alias omen 'source ~nemo/nemo_end'
This can be done at any stage during an interactive terminal session. 
More details can be found in Appendix A of the manual. 
________________________________________________________________________________


The NEMO (latex) manual is located in $NEMO/text/manuals, as nemo.tex
with many small include (.inc) files. There may also be a final nemo.dvi, 
or even nemo.ps file. If not, use the Makefile in there, and try
	make nemo
to create a full manual. If, for one particular include (.inc) file, you 
need a copy one can use:
	make test TEST=setup.inc
and turn the 'latest.dvi' file into a 'latest.ps' file for printing.

The 'nemo.tex' file also generates a table of contents and an index, which
requires you to run the program latex more than once. Also the index
file is not all done by 'latex'. An additional program 'makeindex', which
turns an .idx file into an .ind file, is required. If this is not
present - you'll have to live without the index. Best is to create
a dummy file nemo.ind, to prevent latex screaming about a missing file,
but the nemo.ind file that exists is a current one.

(a version of the makeindex utility lives in $NEMO/src/tools/makeindex)
________________________________________________________________________________

There may also a demo in the $NEMO/demo area. Run it after NEMO has been
installed.
________________________________________________________________________________


Preconditions to INSTALLATION
=============================

The default installation installs NEMO with no graphics library 
(a.k.a. yapp_null). You should consider selecting a well supported
YAPP hookup, e.g. PGPLOT. 

a) Installing PGPLOT

	cd $NEMO/local
	$NEMO/src/scripts/pgplot.install
	(you may need to get the pgplot5.2.tar.gz file from caltech
	or a local repository)

   this assumes $NEMO has a basic presence already, so don't start this
   yet, first figure something out about the installation.

See also $NEMO/src/scripts/

   On some linux systems (e.g. older versions of Redhat) may need to 
		 ln -s /usr/X11R6 /usr/X11

b) Installing HDF
	
-- To be filled in --

c) Installing CFITSIO

   Be aware that at some future point when NEMO is going to use more of cfitsio,
   the fitsio.h header file in NEMO and CFITSIO will cause problems. Note sure
   of what the final resolution is. Perhaps NEMO's fitsio.h will be renamed.

Brief overview of a Version 3.x.y INSTALLATION  
==============================================

 (there is also a bootstrap loader that is a lot easier to use; 
  you may however keep this file at hand when you use that, the procedure
  you follow below is basically what bootstrap does by itself automatically)

1) To untar a compressed tar file the following will do just fine, and
   you never need to save the uncompressed version:

        % gzip -cd nemo_3.x.y.tar.gz | tar xf -

   You can also (if your ftp allows this) do this from within the ftp
   program:

	% cd /usr/nemo
	% ftp astro.umd.edu
	...			(login as anonymous)
	ftp> binary
	ftp> cd pub/teuben/nemo
	ftp> get nemo.tar.gz "|zcat|tar xf -"
	ftp> quit
	% cd nemo_3.x.y

2) Run configure and install the basic libraries:

	% configure
	% source nemo_start
	% make dirs config_extra scripts
	% source NEMORC.local			(or look at $NEMO/src/scripts/NEMORC)
	% rehash
	% make libs

*) Installation problems:

	- edit *.in
		make config config_extra
		
	- edit NEMORC.local (came from NEMORC.gen.in)
		source NEMORC.local

	- edit $NEMOLIB/makedefs (but danger, configure/config_extra can overwrite this)

	- if 'configure' fails for some reason, check the config.log file. Sometimes
	  the cause is a rather trivial one, e.g. missing licences or a bad path or
	  a bad shell.


*) Configuration options known to work:

	--with-pgplot-prefix=$NEMOLIB

		expects grfont.dat and friends to be in the named directory
		($NEMO/src/scripts/pgplot.install will help you
		installing pgplot in $NEMOLIB)

	--with-hdf-prefix=PFX

		expects hdf.h to be found somewhere in an {include,hdf} subdirectory
		and will link with 'df', 'jpeg' and 'z' library.

	--with-miriad-prefix=PFX
		if $MIR is present, it will use this variable

	--disable-fortran
		if you don't have a working fortran compiler
	--with-ccmalloc
		use CCMALLOC to debug malloc usage

* Configuration options that we are working on:

	--with-cfitsio-prefix=PFX 

* Known configurations to work:

	    NEMOHOST			"uname -a" for the machine that worked

	mips-sgi-irix6.5	IRIX64 sulfur 6.5 01101245 IP27
	i686-pc-linux-gnu	Linux nemo 2.2.14-5.0 #1 Tue Mar 7 21:07:39 EST 2000 i686 unknown
	sparc-sun-solaris2.6	SunOS atlas 5.6 Generic_105181-20 sun4u sparc SUNW,Ultra-5_10
	sparc-sun-solaris2.7
	sparc-sun-solaris2.8



*** TODO:

     	- more consistent way between usage of variables in the NEMORC chain, and the 
	  'makedefs' list.

	

ANYTHING BELOW THIS LINE IS FROM NEMO V2 and not always relevant anymore
========================================================================

2) Copy the NEMORC.gen file to NEMORC.local, and edit it to reflect your
   local site. This file is meant to set environment variables that
   had already been set in the NEMORC file, and you need to override.
   It is recommended to study this in some detail, particularly if you're
   not on one of machine to which I don't have frequent access.

	cp NEMORC.gen NEMORC.local

   You can also look at some working examples in $NEMO/src/scripts/NEMORC/

2b) The installation was also designed to allow upgrading your existing
    NEMO version by placing the new tar file on top of your own directory.
    If you are not sure you changed any source code, try this:
        cd $NEMO
        make new
    which  is supposed to check new sourcecode since the last official
    install.  ** i need to write more about this, this can be tricky **

3a) follow the $NEMO/src/bootstrap script to install a fairly complete
    system:

	src/scripts/bootstrap goto=install nemo=$cwd

    this will install all the way through the testsuite, but you will
    probably have to repeat this procedure since the default bootstrap
    currently does not install any graphics (yapp) libraries, just
    yapp_null.
	

3b) follow installation instructions as if NEMO was installed, i.e. add stuff
   to your .cshrc file:

	setenv NEMO /usr/nemo		(or "setenv NEMO `pwd`")
	source $NEMO/NEMORC
	...
	set path = ( . $NEMOBIN $path )



4) Bootstrap the system 

   % cd $NEMO   
   % make config  
   % make dirs 
   % make config_extra
   % make scripts

5) Make the library ($NEMOLIB/libnemo.a)

   % cd $NEMO/src
   % make clean install

   Before you run this, you may want to check/change 

   a) which loadobj to use - this MUST be choosen correctly
      by using the right CC flag, or fiddling with $NEMOINC/options.h

      For the following machines this is all pre-defined:
            sun3
            sun4 (sparc/sunos)
            sun5 (sparc/solaris)
            alpha (tested on: OSF1 V3.2, but V2.x probably won't work)
            sgi (tested on: IRIX V5.2, but V4.x probably won't work)
            linux (tested on 2.x, slackware 3.1 all the way through redhat 6.0)
		
   b) all yapp's are compiled into .o files, and not
      put into library; in accordance with using YAPPLIB
      environment variable at compile time to set it

   c) which options to (un)set in src/kernel/io/getparam.c (the
      user interface). A dryrun with 
            cc -c getparam.c 
      will do fine. Don't forget to remove getparam.o before
      official installation.


6) Compile hackcode, the C version of the treecode

   % cd $NEMO/src/nbody/evolve/hackcode/hackcode1; make hackcode1;
        mv hackcode1 $NEMOBIN
or equivalently:
   % mknemo hackcode1


6) Compile a few utilities, pick what you want....

   % cd $NEMO/src/nbody/tools ; make atos stoa ; mv atos stoa $NEMOBIN
   or
   % mknemo atos stoa tabtos tsf
   and a somewhat special
   % mknemo -c history hisf
 

   % cd $NEMO/src/nbody/init  ; make mkplummer ; mv mkplummer $NEMOBIN
   or
   % mknemo mkplummer

   % cd $NEMO/src/nbody/reduc ; make snapplot snapdiagplot ;
            mv snapplot snapdiagplot $NEMOBIN
   These last two will also tell you if the proper YAPPLIB was choosen.
   (Otherwise the EL macro may be used, e.g. as in:
		make snapplot EL="$YAPP_MONGO"
   The NEMORC must be setup for this properly. Local things should really
   be done in the NEMORC.local file. If it is not present, create one.
   Preferably you would want to keep away from editing the NEMORC file,
   since in updates you'd have to figure out what to retain and what to
   keep from this file, and again create you private version....

Again, if you want to change the default yapp graphics device; the
environment variable YAPPLIB needs to be reset to any of the YAPP_... 
ones in $NEMO/NEMORC file.  Make those changes to your NEMORC.local
file, not the ones that get updated when you get a new NEMO release
from me :-)


Some examples of patch work, mostly using the local Makefile's:

* Updating libnemo.a with a fixed set of routines:

	make install OBJFILES="a.o b.o c.o"

* Compiling a graphics program with another library:

	make snapplot YAPPLIB="$YAPP_MONGO"

* Compiling something with an extra library:

	make ccdfft EL=-lfft

* Compiling a program that does not need loadobj() and can hence be
  compiled without the -Bstatic in $NEMOBIN/cc. This is peculiar to
  some architectures, e.g.

	make atos CC="/bin/cc -I$NEMOINC"

  It will create significantly smaller executables since shared
  libraries are used. On Solaris this will be the default.

* Testbed functions:

  Some functions in the $NEMO/src/kernel tree, and in some of the other
  places, can be compiled into an exectuable, for debugging purposes.
  Compilation of such testbed routines is accomplished by a piece of
  main() code [or nemo_main() for all that matters] #ifdeffed by a
  TESTBED test.
  To compile them, one can generally use

        make getparam CFLAGS="-g -DTESTBED"

  or, if provided for in the Makefile:

        make getpartest

7) Testsuite:
  Once you have basic compilation going, you should run the testsuite.
This is a shell script that will help you find all the test scripts
(as defined by a makefile-based Testfile in the various directories in
$NEMO), identify the programs needed for the tests, compile those programs,
and then run a whole series of tests.
You can then compare the output of the testsuite against a baseline 
release and get an idea if your newly compiled version of NEMO is producing
reasonable data.

First query and install all programs needed:

	$NEMO/src/scripts/testsuite -q -i

The bootstrap script actually also runs the standard testsuite.

ERROR:::: found /data/nemo/src/nbody/evolve/scfm/scfm.f
f77 -O  -c scfm.f -o scfm.o
f77 -O -o scfm scfm.o
scfm.doc open: No such file or directory
apparent state: unit 10 named SCFPAR
last format: list io
lately writing direct formatted external IO
Abort (core dumped)
 [was up to date] Well done




Peculiar things:
=--------------=

strip: do not strip programs which use the dynamic object loader, they
       will not be able to find local code

DS:   A display program for images (autodetects FITS, IRAF, NEMO, etc. format)

      % cd $NEMO/src/tools/ds
      % <edit the "conf.h" file appropriately (usually check if NEMO is set to 1)
      % make ds EXTRALIBS=$NEMOLIB/libnemo.a
      % rm ds
      % make ds CC=/bin/cc EXTRALIBS=$NEMOLIB/libnemo.a
      % mv ds $NEMOBIN
      % make clean

      Deleting 'ds' and remaking it with different CC makes it load in
      dynamic mode, otherwise the binary 'ds' would be very large due to
      forced static loading (-Bstatic) that is normally needed in Nemo
      these days. Check out the $NEMOBIN/cc script in case of doubt.

      There is now an X version of 'ds' available. This will overwrite
      the sunview version in NEMO at some time soon.

NEMOTOOL/NEMO:
      See miriad target in $NEMO/Makefile. It should install miriad
      from $NEMO/src/tools/miriad/miriad and nemotool from
      from $NEMO/src/tools/miriad/mirtool.
      


Troubleshooting:

In case of reporting errors it helps to have the following information
available:

  - your architecture (hardware and operating system version, amount of
    memory, disk space etc.)
  - your NEMORC.local file
  - any other modifications you've made to NEMO



Other miscellanious items:

     By the way, the best run-time performance from Sun compilers for
     compute-bound applications is usually obtained from some combination of the
     following compile-time options:
     
     Fortran 1.3.1:
             -O4 -cg89 -libmil -dalign -fnonstd -Bstatic
     C 1.0:
             -O4 -cg89 -libmil -dalign -fnonstd -Bstatic -fsingle
    
     These are discussed in the Numerical Computation Guide which accompanies C 1.0
     and Fortran 1.3.1.  Also the default swap and /tmp partitions supplied by
     SunOS are often insufficient to fully optimize some large programs.  Use
     swapon(8) in the first instance and -temp=..., described in cc(1) and f77(1),
     in the second instance.
		     
		     (dgh@validgh.com)

Programming development:
========================

bake prog

	Compiles and links prog.c with nemo

IBM Risc (IBM AIX 3.1)
======================

- cc compiler needs -qnoro (like gnu's -fwriteable-strings)
  We use -Daix to create the trigger needed to resolve some
  NULL issues. In this respect /bin/cc and /bin/xlc behave
  differently? The solution was to bypass the 
	#define NULL (void *)0
  in their <stdio.h> and use ours
	#define NULL 0
  Since the former is ANSI, we should do something about this in
  NEMO.

- Fortran_to_C linking: symbol names are the same, i.e. not the
  BSD convention of appending underscores. All else seems to be
  the same, in particular using character variables. Not tested
  well though. (nbody0)
  If you use the default FC to link, it will fail in e..g. getenv,
  because the wrong getenv (fortran) is loaded by the linker;
  instead this will compile nbody0:
  First compile all in .o files:
        make nbody0
  it WILL create a binary, but it won't run. Then
        rm nbody0
        make nbody0 FC=cc FORLIBS=
  which links and suggests that cc is smart enough to find any
  needed FORLIBS, since we supplied none (the standard libF77.a
  et al. are absent on AIX)




Example:	SGI/SOLARIS installations

mkdir nemo_2.4.0
cd nemo_2.4.0
ncftp ftp.astro.umd.edu:/progs/nemo/nemo_2.4.0.tar.gz	12 Mb uncompressed
time gtar zxf nemo_2.4.0.tar.gz	    3.123u 11.620s 2:43.59	(wang)
                                    1.337u 6.916s 1:08.23	(onyx)
				    0.88u 3.72s 1:17.66 5.9% (ultra)


	-> alternatively: 
			src/scripts/bootstrap goto=install nemo=$cwd
setenv NEMO `pwd`
source NEMORC
set path=(. $NEMOBIN $path[2-])
rehash

make dirs scripts
which cc 			<-- make sure it's $NEMOBIN/cc
which make			<-- make sure it's $NEMOBIN/make
cd src
time make install >& make1.log	40.499u 41.344s 3:25.73 39.7% (wang's machine)
                                12.394u 17.417s 0:33.37 89.3% (onyx)
				37.58u 19.00s 1:34.53 59.8% (ultra)

mknemo tsf
mknemo -c history hisf
mknemo hackcode1
time hackcode1 > /dev/null      1.923u 0.021s 0:02.79 69.5%
                                0.555u 0.010s 0:00.57 98.2% (onyx)
				1.46u 0.02s 0:01.86 79.5% (ultra)

cd $NEMO/src/scripts
need -m `testsuite -s` > $NEMO/tmp/log1
testsuite -q
time testsuite			(wang's sgi)
				(onyx)
				5.54u 5.62s 0:15.05 74.1% (ultra)

Problems:

    IRIX 6 doezn't appear to need -lbsd aymore, IRIX 5 needs it?    .
    IRIX 6 cannot handle fitsio?                                    fixed
    tabmath fails: no EOF on getc ?                                 .
    yapp_gl:    how to do null output?                              .
    IRIX cannot handle with out MANPATH method
