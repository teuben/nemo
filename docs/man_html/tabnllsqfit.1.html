<!-- manual page source format generated by PolyglotMan v3.2, -->
<!-- available at http://polyglotman.sourceforge.net/ -->

<html>
<head>
<title>TABNLLSQFIT(1NEMO) manual page</title>
</head>
<body bgcolor='white'>
HTML automatically generated with <A HREF=http://manpages.ubuntu.com/manpages/bionic/man1/rman.1.html>rman</A><br>
<a href='#toc'>Table of Contents</a><p>

<h2><a name='sect0' href='#toc0'>Name</a></h2>
tabnllsqfit - general purpose non-linear least squares fitting program

<h2><a name='sect1' href='#toc1'>Synopsis</a></h2>
<p>
<b>tabnllsqfit in=</b>table-file [parameter=value] 
<h2><a name='sect2' href='#toc2'>Description</a></h2>
<b>tabnllsqfit</b>
takes a non-linear least squares fit (minimized ChiSquared) of a set of
datapoints (x(i),y(i)) where a functional form y=f(x;p0,p1,...,pN) is assumed.
The function is not required to be non-linear in it parameters. Although
a number of common pre-defined functional forms can be selected (see <b>fit=</b>),
you can also write a small C routine, and dynamically load the fitted function
during runtime (see <b>load=</b>). <p>
The inputfile is an ascii file in a tabular
format, where on every line there must be an assigned column for the X-
and Y-coordinate(s).  An optional column can be assigned to the errors in
Y  (the DY-coordinates, the inverse square of these being used as a weight).
If no DY-column is assigned, it is assumed that the errors in Y are all
the same and equal to 1. Lines starting with the &rsquo;#&rsquo; symbol are comment  lines.
Certain models (see <b>fit=</b> below) allow multiple X or Y columns.  <p>
Each fit
can also produce an output file with an additional column computing the
difference between the data and the model (in that order). In the special
case where the user has supplied no free parameters, the residuals are
still computed correctly. <p>
This routine can also be used to plot the function,
although only in 1D cases, see <b>x=</b>. 
<p> 
<h2><a name='sect3' href='#toc3'>Parameters</a></h2>
The following parameters are
recognized in any order if the keyword is also given: 
<dl>

<dt><b>in=<i>in-file</i></b> </dt>
<dd>(ascii)
input file, a table of values from which data is taken. No default. </dd>

<dt><b>xcol=<i>col,...</i></b>
</dt>
<dd>The column(s) from which the (independant) X-values are taken. The first
column is numbered 1 [default: <b>1</b>]. </dd>

<dt><b>ycol=<i>col,...</i></b> </dt>
<dd>The column(s) from which the
(dependant) Y-values are taken  [default: <b>2</b>]. </dd>

<dt><b>dycol=<i>int</i></b> </dt>
<dd>Optional column from
which the weights will be derived. By default this column is meant to refer
to an error bar, and normally  the inverse square of the errors are uses
as weights for those fits where these are used (see <b>dypow=</b> next). [default:
none assigned]. </dd>

<dt><b>dypow=<i>power</i></b> </dt>
<dd>By changing this value, you can adjust the weights
column (<b>dycol</b>). Instead of the normal <i>weight = 1/sigma^2</i>, you will be able
to use them as <i>weight^dypow</i>. The most common use is when your <b>dycol</b> does
not refer to an error, but to the weight directly (e.g. an intensity), in
which case <b>dypow=-0.5</b> is appropriate. [default: 1]. </dd>

<dt><b>xrange=<i>xmin:xmax,xmin:xmax,...</i></b>
</dt>
<dd>Range in X-values for which the fit is done. A set of min:max, separated
by comma&rsquo;s, can be given. This keyword cannot be used if more than one X-column
is used. [default: no entry, i.e. all]. </dd>

<dt><b>fit=</b><i>model</i> </dt>
<dd>Model name what to fit. Currently
implemented are <i>line</i>, <i>plane</i>, <i>poly</i>, <i>gauss1d</i>, <i>loren</i>, and <i>exp</i>. [default: <b>line</b>].
</dd>

<dt><b>order=</b><i>order</i> </dt>
<dd>Highest order of the polynomial fit (<b>fit=poly</b>) or  number of
dimension of the hyper-plane fit (<b>fit=plane</b>). 0 would fit a constant.  [Default:
<b>0</b>]. </dd>

<dt><b>out=</b><i>filename</i> </dt>
<dd>Optional output filename where the data and residuals are
stored. The first few columns contain the X and Y columns, the last column
contains the residual Y-F(X). See an example below how to plot the data with
a model fit overlayed. [default: no output file created]. </dd>

<dt><b>nsigma=<i>sigma_factor</i></b>
</dt>
<dd>A positive number will delete points more than <i>sigma_factor</i> from the fit,
and fit again. Multiple values can be given here, in which case multiple
iterations are done. [Default: <b>-1</b>]. </dd>

<dt><b>par=</b> </dt>
<dd>Initial estimates for the parameters.
For non-linear fits, or linear fits where certain parameters are fixed (see
<b>free=</b> below) they need to be given here. Some fits (e.g. gauss1d) do not require
an initial estimate and attempt to come up with a reasonable one. Otherwise
all initial parameters are 0. </dd>

<dt><b>free=</b> </dt>
<dd>A list of 1&rsquo;s and 0&rsquo;s to set which parameters
are to be kept <a href='free.1.html'>free (1)</a>
 and which are fixed (0). By default all parameters
are free, i.e. fitted. If any parameter is fixed, initial estimates for all
need to be given (see <b>par=</b>). Default: all parameters free. </dd>

<dt><b>load=</b> </dt>
<dd>If given,
this should contain the full path to a compiled and  shared object (.so)
file) that contains the function to be fitted  in terms of the <i>nllsqfit</i>
parameters <i>f</i> and <i>df</i>. They must be named <b>func_loadobj</b> and <b>derv_loadobj</b> (maybe
modified with fit=). See LOAD FUNCTIONS below. </dd>

<dt><b>x=</b> </dt>
<dd>If given, these are the
X-values for which the load function can be tested. It is useful for testing
and debugging your function. It will report the X, Y and the dY/dPAR vector
values. The program will exit after this, and no fitting is done.  If the
first two values are the <b>same</b>, a numerical derivate is computed (see below).
Default: none. </dd>

<dt><b>nmax=</b><i>max_lines</i> </dt>
<dd>Maximum number of lines allocated if the input
file was being read from a pipe. If not, the routine <a href='file_lines.3.html'><i>file_lines(3NEMO)</i></a>
 is
used to allocate space for the table. [Default: <b>10000</b>]. </dd>

<dt><b>tol=</b> </dt>
<dd>Tolerance for
convergence of <i>nllsqfit</i> [Default: <b>0.0</b>]. </dd>

<dt><b>lab=</b> </dt>
<dd>Mixing parameter for <i>nllsqfit</i>
[Default: <b>0.0</b> for linear, <b>0.1</b> for non-linear fits]. </dd>

<dt><b>itmax=</b> </dt>
<dd>Maximum number of
allowed <i>nllsqfit</i> iterations [Default: <b>50</b>] </dd>

<dt><b>format=</b> </dt>
<dd>Output format. Default
%g </dd>

<dt><b>bootstrap=</b> </dt>
<dd>Number of bootstrap samples to take to estimate the error
in the parameters. Output off all parameters and their errors are on one
line containing the word bootstrap. Parameters and their errors are output
in pairs. Default:0 </dd>

<dt><b>seed=</b> </dt>
<dd>Initial seed. See <a href='xrandom.3.html'><i>xrandom(3)</i></a>
 for more details. Default:
0 </dd>

<dt><b>method=g|n|m</b> </dt>
<dd>Fitting method. Gipsy uses their <a href='nllsqfit.3.html'><i>nllsqfit(3NEMO)</i></a>
, NumRec uses
their <i>mrqfit</i> and MINPACK uses <a href='mpfit.3.html'><i>mpfit(3NEMO)</i></a>
.  Only first character is used,
case insensitive.  [Default: <b>g</b>] 
<p> </dd>
</dl>

<h2><a name='sect4' href='#toc4'>Fit Parameters</a></h2>
Parameters are referred to
as p0,p1,p2,p3,..... <br>
<pre>line     <tt> </tt>&nbsp;<tt> </tt>&nbsp;y=p0+p1*x                        (same as poly,order=1)
plane       <tt> </tt>&nbsp;<tt> </tt>&nbsp;z=p0+p1*x+p2*y                   (example order=2)
polynomial  <tt> </tt>&nbsp;<tt> </tt>&nbsp;y=p0+p1*x+p2*x^2+p3*x^3...       (example order=3)
gauss1d       <tt> </tt>&nbsp;<tt> </tt>&nbsp;y=p0+p1*exp(-(x-p2)^2/(2*p3^2))
gauss2d       <tt> </tt>&nbsp;<tt> </tt>&nbsp;y=p0+p1*exp(-[(x-p2)^2+(x-p3)^2]/(2*p4^2))
exp<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;y=p0+p1*exp(-(x-p2)/p3)
grow<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;y=p0*(exp(x/p1)-1)
arm<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;y=p0+p1*cos(x)+p2*sin(x)
arm3<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;y=p0+p1*cos(x)+p2*sin(x)+p3*cos(3*x)+p4*sin(3*x) 
loren<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;y=p1/PI( (x-p0)^2 + p1^2 )
psf<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;y=p1*x^p2*sin(y)^p3+p4
</pre>
<h2><a name='sect5' href='#toc5'>Example</a></h2>
Here is an example of a linear fit: a straight  line, with some
added noise and random weights between 1 and 2: <br>
<pre>% nemoinp 1:100 |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;tabmath - - "%1+rang(0,10),ranu(1,2)" seed=123 |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;tabnllsqfit - 1 2 3
nrt=0
Fitting a+bx:  
a= 1.50492 2.25695 
b= 1.00159 0.0380961
</pre>Here is an example of a 2D plane  in 3D: (1+2x+3y) <br>
<pre>% ccdmath "" - &rsquo;1+2*%x+3*%y+rang(0,0.1)&rsquo; 5,5 seed=123 |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;ccdprint - x= y= label=x,y newline=t |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;tabnllsqfit - 1,2 3 fit=plane order=2
nrt=0
Fitting p0+p1*x1+p2*x2+.....pN*xN: (N=2)
p0= 1.0688 0.0523819
p1= 2.01497 0.0165646
p2= 2.97436 0.0165646
</pre>And a fit to a gaussian: <br>
<pre>% nemoinp 1:100 |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;tabmath - - &rsquo;4+exp(-(%1-50)**2/(200))+ranu(0,1)&rsquo; seed=123 |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;tabnllsqfit - fit=gauss1d par=4,1,50,10
nrt=13
Fitting a+b*exp(-(x-c)^2/(2*d^2)):  
a= 4.46714 0.0416026 
b= 1.13036 0.0994723 
c= 50.2263 0.845469
d= 8.70728  0.959347
rms2/chi2= 8.92068
rms/chi = 1
</pre>Here is a contrived example of plotting the function to be plotted, by
fixing all parameters and computing a residual table from 0s: <br>
<pre>% nemoinp 0:10:0.1 | tabmath - tab0 0
% tabnllsqfit tab0 1 2 fit=gauss par=1,2,5,1 free=0,0,0,0 out=tab0.d
% tabmath tab0.d - %1,-%3 | tabplot -
</pre>
<p> Here is an example of removing outlier points and fitting again: 
<p> <br>
<pre>% nemoinp 1:10 |\
   tabmath - - &rsquo;2*%1+1+rang(0,0.1)&rsquo; seed=123 |\
   tabnllsqfit - fit=line nsigma=1.5::3
nrt=0
Fitting a+bx:  
a= 1.09548 0.0775617 
b= 1.99937 0.0125002
2/10 points outside 1.5*sigma (0.152328)
nrt=0
Fitting a+bx:  
a= 1.02651 0.0452119 
b= 2.01358 0.00753531
0/8 points outside 1.5*sigma (0.080422)
</pre>Although 3 iterations were requested, after the first iteration no more
points were removed, and the iterations were stopped. <p>
Here is an example
of estimating the errors via a bootstrap (resampling of errors)  method.
Fitting a polynomial of order 2 and taking 100 bootstrap samples: <br>
<pre>% tabnllsqfit tab11 fit=poly order=2 bootstrap=100
nrt=0
Fitting p0+p1*x+p2*x^2+.....pN*x^N: (N=2)
p0= 3.11325 0.192787
p1= 1.97474 0.0896959
p2= 0.00157311 0.008639
bootstrap= 3.11603 0.164922 1.96464 0.086429 0.00293632 0.00820007 
             ^^^^    ^^^^^   ^^^^^    ^^^^^    ^^^^^^      ^^^^^^
              P0      dP0      P1      dP2       P3         dP3
</pre>
<p> 
<h2><a name='sect6' href='#toc6'>Load Functions</a></h2>
With the <b>load=</b> keyword dynamic object files can be loaded
using the <a href='loadobj.3.html'><i>loadobj(3NEMO)</i></a>
 mechanism. The convention is that two functions
must be externally visible, and named <i>func_</i><i>method</i> and <i>derv_</i><i>method</i>  (where
<i>method</i> is the same as the <b>fit=</b> keyword. <p>
Here is an example of the file <b>myline.c</b>
that can be used with <b>fit=line load=myline.so</b> and compiled with <br>
<pre><tt> </tt>&nbsp;<tt> </tt>&nbsp;bake myline.so
</pre>
<p> <br>
<pre>/* File:  myline.c  */
#include &lt;stdinc.h&gt;
real func_line(real *x, real *p, int np) 
{
  return p[0] + p[1]*x[0];
}
void derv_line(real *x, real *p, real *e, int np) 
{
  e[0] = 1.0;
  e[1] = x[0];
}
</pre>
<p> One word of caution: if you find the program having a hard time finding
a solution in complex cases, it is quite possible that this is not due
to the fact that the function is complex, but due to noise or bad initial
conditions. 
<h2><a name='sect7' href='#toc7'>Derivatives Check</a></h2>
A common debug problem is to check the analytical
derivatives in your external loaded function. The <b>x=</b> keyword can be used
to check the function values (useful to plot up the function for a given
set of parameters in <b>par=</b>), in which also all the partial derivatives are
listed: <br>
<pre>   % cd $NEMO/src/kernel/tab/fit ; bake gaussn.so
   % echo 1 1 | tabnllsqfit - load=gaussn.so fit=gaussn par=1,2,1,0.2 x=1.1:1.4:0.1
   1.1 2.76499   1 0.882497 4.41248 2.20624
   1.2 2.21306   1 0.606531 6.06531 6.06531
   1.3 1.6493   1 0.324652 4.86979 7.30468
   1.4 1.27067   1 0.135335 2.70671 5.41341
</pre>But to check if the analytical derivates in <i>derv_gaussn()</i> are correct,
 repeating the same value of <b>x</b> a number of times, each parameter is incremented
by a decreasing factor of 0.1  
<p> <br>
<pre>   % echo 1 1 | tabnllsqfit - load=gaussn.so fit=gaussn par=1,2,1,0.2 x=1.4::4
   # par iter Y dP  (Y-Y0)/dP   [(Y-Y0)/dP  - dY/dP]
   0 0 1.37067 0.1 1 [8.88178e-16]
   0 1 1.32067 0.05 1 [5.32907e-15]
   ...
   0 9 1.27087 0.000195313 1 [1.36424e-12]
   1 0 1.2842 0.1 0.135335 [2.16493e-15]
   ...
   2 0 1.6493 0.1 3.78634 [1.07964]
   2 1 1.43253 0.05 3.2372 [0.53049]
   ...
   2 8 1.27173 0.000390625 2.71067 [0.00396662]
   2 9 1.2712 0.000195313 2.70869 [0.00198288]
   3 0 1.82222 0.1 5.51554 [0.102129]
   3 1 1.55607 0.05 5.70808 [0.294669]<tt> </tt>&nbsp;<tt> </tt>&nbsp;
   ...
   3 8 1.27279 0.000390625 5.41867 [0.00525903]
   3 9 1.27173 0.000195313 5.41605 [0.00263639]
</pre>You can see that the offset (par 0) and amplitude (par 1) of the gauss
are well behaved (as they are linear), but the centroid (par 2) and width
(par 3) of the gauss only slowly converge linearly with the step. The last
number in square brackets is the error between numerical and analytical
derivative. 
<h2><a name='sect8' href='#toc8'>Caveats</a></h2>
It will not recognize linear fits if the non-linear parameters
are kept fixed, e.g. the offset 0 in <b>fit=gauss1d</b>. 
<h2><a name='sect9' href='#toc9'>See Also</a></h2>
<a href='tablsqfit.1.html'>tablsqfit(1NEMO)</a>
,
<a href='tabhist.1.html'>tabhist(1NEMO)</a>
, <a href='tabmath.1.html'>tabmath(1NEMO)</a>
,  <a href='gaussfit.1.html'>gaussfit(1NEMO)</a>
, <a href='linreg.1.html'>linreg(1NEMO)</a>
, <a href='nllsqfit.3.html'>nllsqfit(3NEMO)</a>
,
fit.dc1(GIPSY) <p>
<i>Numerical Recipies in C, Ch.14</i> <p>
NLREG: <a href='http://www.nlreg.com'>http://www.nlreg.com</a>
 <p>
NIST
non-linear: <a href='http://www.itl.nist.gov/div898/strd/lls/lls.shtml'>http://www.itl.nist.gov/div898/strd/lls/lls.shtml</a>
 <p>
NIST linear: <a href='http://www.itl.nist.gov/div898/strd/nls/nls_main.shtml'>http://www.itl.nist.gov/div898/strd/nls/nls_main.shtml</a>

<p>
fityk: <a href='http://fityk.nieto.pl/'>http://fityk.nieto.pl/</a>
 <p>
A new scheme for calculating weights and describing
correlations in nonlinear least squares fits. (Hessler, Curent &amp; Ogren, C.I.P.
10, 186, 1996):  <a href='http://dx.doi.org/10.1063/1.168569'>http://dx.doi.org/10.1063/1.168569</a>
  
<h2><a name='sect10' href='#toc10'>Author</a></h2>
Peter Teuben 
<h2><a name='sect11' href='#toc11'>Files</a></h2>
<br>
<pre>~/src/kernel/tab<tt> </tt>&nbsp;<tt> </tt>&nbsp;tabnllsqfit.c
~/src/kernel/tab/fit<tt> </tt>&nbsp;<tt> </tt>&nbsp;example fitting functions
</pre>
<h2><a name='sect12' href='#toc12'>Update History</a></h2>
<br>
<pre>12-jul-02<tt> </tt>&nbsp;<tt> </tt>&nbsp;V1.0 cloned off tablsqfit<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
17-jul-02<tt> </tt>&nbsp;<tt> </tt>&nbsp;V1.1 added load=, x=, numrec=<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
11-sep-02<tt> </tt>&nbsp;<tt> </tt>&nbsp;V1.1e  changes error/warning to accomodate residual writen<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
21-nov-02<tt> </tt>&nbsp;<tt> </tt>&nbsp;V1.4 nsigma= can be an array of iterations<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
14-feb-03<tt> </tt>&nbsp;<tt> </tt>&nbsp;V1.6 arm,arm3 for Rahul<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
21-mar-03<tt> </tt>&nbsp;<tt> </tt>&nbsp;V1.7 added bootstrap=, seed=<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
4-apr-03<tt> </tt>&nbsp;<tt> </tt>&nbsp;V1.8 fixed error in using dycol=, and introduced dypow=<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
15-mar-04<tt> </tt>&nbsp;<tt> </tt>&nbsp;V1.8b added fit=loren and corrected lab= setting for functions<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT/RS
21-nov-05<tt> </tt>&nbsp;<tt> </tt>&nbsp;V2.0 added fit=gauss1d,gauss2d<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
24-apr-08<tt> </tt>&nbsp;<tt> </tt>&nbsp;V2.1 added psf<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
7-may-10<tt> </tt>&nbsp;<tt> </tt>&nbsp;V2.2 added grow<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
24-dec-11<tt> </tt>&nbsp;<tt> </tt>&nbsp;V2.3b estimate gauss1d if no initial par given<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
9-dec-12<tt> </tt>&nbsp;<tt> </tt>&nbsp;V3.0 new style xrange= with multiple segments<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
9-oct-13<tt> </tt>&nbsp;<tt> </tt>&nbsp;V4.0 numrec= is now method=  for mpfit trials, add function deriv
checker<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
</pre>
<p> <p>

<hr><p>
<a name='toc'><b>Table of Contents</b></a><p>
<ul>
<li><a name='toc0' href='#sect0'>Name</a></li>
<li><a name='toc1' href='#sect1'>Synopsis</a></li>
<li><a name='toc2' href='#sect2'>Description</a></li>
<li><a name='toc3' href='#sect3'>Parameters</a></li>
<li><a name='toc4' href='#sect4'>Fit Parameters</a></li>
<li><a name='toc5' href='#sect5'>Example</a></li>
<li><a name='toc6' href='#sect6'>Load Functions</a></li>
<li><a name='toc7' href='#sect7'>Derivatives Check</a></li>
<li><a name='toc8' href='#sect8'>Caveats</a></li>
<li><a name='toc9' href='#sect9'>See Also</a></li>
<li><a name='toc10' href='#sect10'>Author</a></li>
<li><a name='toc11' href='#sect11'>Files</a></li>
<li><a name='toc12' href='#sect12'>Update History</a></li>
</ul>
</body>
</html>
