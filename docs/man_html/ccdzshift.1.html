<!-- manual page source format generated by PolyglotMan v3.2, -->
<!-- available at http://polyglotman.sourceforge.net/ -->

<html>
<head>
<title>CCDZSHIFT(1NEMO) manual page</title>
</head>
<body bgcolor='white'>
<a href='#toc'>Table of Contents</a><p>

<p> 
<h2><a name='sect0' href='#toc0'>Name</a></h2>
ccdzshift - re-align (stack) spectra from a cube based on a reference

<p>map 
<p> 
<h2><a name='sect1' href='#toc1'>Synopsis</a></h2>
<b>ccdzshift</b> [parameter=value] 
<p> 
<h2><a name='sect2' href='#toc2'>Description</a></h2>
<b>ccdzshift</b> re-align
all spectra in a cube based on a reference map of where a reference Z value
(<i>velocity</i>) centroid should be. The shift is towards the center of the cube.
In some sense this is like stacking spectra, except in this stage it will
keep all spectra in their respective pixels. Another step is needed (e.g.
<a href='ccdmom.1.html'><i>ccdmom(1NEMO)</i></a>
) to produce a truly single stacked spectrum. <p>
The current version
is optimized for galaxy cubes, where everything is velocity based, and
searching for low density gas in the outer regions. Another application
is high-Z frequency based, and stack based on certain spectral lines and
look for a signal. 
<p> 
<h2><a name='sect3' href='#toc3'>Parameters</a></h2>
The following parameters are recognized in
any order if the keyword is also given: 
<dl>

<dt><b>in=</b> </dt>
<dd>Input image cube. No default.
</dd>

<dt><b>map=</b> </dt>
<dd>Z reference map. The values in the map must correspond to the WCS values
of the Z axis of the input cube. No default. </dd>

<dt><b>out=</b> </dt>
<dd>Re-aligned output cube. No
default. </dd>

<dt><b>wcs=0|1|2</b> </dt>
<dd>0=use 0-based pixel 1=use 1-based pixel 2=use WCS [2] </dd>

<dt><b>nearest=t|f</b>
</dt>
<dd>Shift spectra using nearest pixel, or a more expensive interpolate? [t]
</dd>

<dt><b>center=</b> </dt>
<dd>If given, this pixel will be the reference centroid of the cube.
Although this gives the option to crop a large cube to a smaller one to
contain the final signal, it will corrupt the WCS. 
<p> </dd>
</dl>

<h2><a name='sect4' href='#toc4'>Examples</a></h2>
Following along
the example in <a href='ccdvel.1.html'><i>ccdvel(1NEMO)</i></a>
 we have make an example with a falling density
in the outer parts to see how much can be recovered using stacking (shifting)
and integrating in elliptical rings. Some noise is added to ensure the outer
regions to ensure the line is buried in the noise, unless the signal is
stacked/integrated in rings: <br>
<pre>  # make lookup tables
  nemoinp 0:140:5 &gt; map1.radt
  tabmath map1.radt map1.dent  "exp(-%1/20)" all
  tabmath map1.radt map1.velt  "%1/sqrt(40+%1*%1)" all
  # plot the density (red in pgplot) and velocity (green in pgplot) vs.
radius
  paste map1.radt map1.dent map1.velt | tabplot - 1 2,3 color=2,3 line=2,1
  # velocity and density
  ccdvel out=map1.vel radii=@map1.radt vrot=@map1.velt pa=45 inc=60 size=256
vsys=10
  ccdvel out=map1.den radii=@map1.radt vrot=@map1.dent pa=45 inc=60 size=256
amp=t
  # cube with and without noise
  velcube invel=map1.vel inden=map1.den out=map1.cube sigdefault=0.1 zrange=8:12
nz=200 
  velcube invel=map1.vel inden=map1.den out=- sigdefault=0.1 zrange=8:12 nz=200
|\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;ccdmath - map1n.cube &rsquo;%1+rang(0,0.001)&rsquo;
  # shifted cubes (adding noise back where it was lost due to the shift)
  ccdzshift map1.cube  map1.vel  map2.cube
  ccdzshift map1n.cube map1.vel  - |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;ccdmath - map2n.cube &rsquo;ifeq(%1,0,%1+rang(0,0.001),%1)&rsquo;
  ccdellint map2.cube  0:200:2 pa=45 inc=60 vsys=10 center=128,128 out=map2.rv
  ccdellint map2n.cube 0:200:2 pa=45 inc=60 vsys=10 center=128,128 out=map2n.rv
  ccdellint map2n.cube 0:200:2 pa=45 inc=60 vsys=10 center=128,128 out=map2m.rv
norm=f
  ccdmom map2n.rv - axis=2 mom=0 | ccdprint - x= newline=t label=x  |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;tabmath - - &rsquo;%1,log(%2)&rsquo; all | tabplot - 1 2 color=2 point=2,0.1 line=1,1 xcoord=140
  ccdmom map2n.rv - axis=2 mom=1 | ccdprint - x= newline=t label=x  |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;tabplot - 1 2 color=2 point=2,0.1 line=1,1 ymin=9 ymax=11 xcoord=140
  ccdmom map2n.rv - axis=2 mom=2 | ccdprint - x= newline=t label=x  |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;tabplot - 1 2 color=2 point=2,0.1 line=1,1 ymin=0 ymax=2  xcoord=140
  # this mom=2 plot has lots of NaN&rsquo;s at radii
</pre>A more realistic example would be to use observational data. Lets say we
have a cube, and a velocity field. First recifying the cube, then averaging
all emission along the RA (x) and DEC (y) axis, we get a single spectrum
along z, plotted using <a href='tabplot.1.html'><i>tabplot(1NEMO)</i></a>
: 
<p> <br>
<pre>  ccdmom ngc6503.ccd ngc6503vel.ccd mom=1 rngmsk=t clip=0.002
  ccdzshift ngc6503.ccd ngc6503vel.ccd ngc6503_0.ccd
  ccdmom ngc6503_0.ccd - axis=1 |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;ccdmom - - axis=2 |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;ccdprint - x= y= z= |\
<tt> </tt>&nbsp;<tt> </tt>&nbsp;tabplot - 0 1 line=1,1 ycoord=0 point=2,0.05
  nds9 ngc6503_0.ccd
</pre>
<p> 
<h2><a name='sect5' href='#toc5'>Caveat</a></h2>
It is assumed the Z axis is in velocity, a Frequency or Wavelength
axis is not supported. You will need to convert to a velocity axis in another
package. We give two examples, the first one in MIRIAD: <br>
<pre>  fits in=ngc6503.fits out=ngc6503.mir op=xyin
  velsw in=ngc6503.mir axis=VRAD
  fits in=ngc6503.mir out=ngc6503vrad.fits op=xyout
  fitsccd ngc6503vrad.fits - | ccdhead -
     Z-range:   261.861 -196.743
     MinMax:    -0.00315721 0.0169835

and one in CASA, which delivers in m/s

  importfits(&rsquo;ngc6503.fits&rsquo;,&rsquo;ngc6503.im&rsquo;)
  exportfits(&rsquo;ngc6503.im&rsquo;,&rsquo;ngc6503vrad.fits&rsquo;,velocity=True)
  fitsccd ngc6503vrad.fits - | ccdhead -
      Z-range:   261861 -196743
      MinMax:    -0.00315721 0.0169835
</pre>
<p> 
<h2><a name='sect6' href='#toc6'>See Also</a></h2>
<a href='nemoinp.1.html'>nemoinp(1NEMO)</a>
, <a href='tabmath.1.html'>tabmath(1NEMO)</a>
, <a href='ccdvel.1.html'>ccdvel(1NEMO)</a>
, <a href='ccdmath.1.html'>ccdmath(1NEMO)</a>
,
<a href='ccdmom.1.html'>ccdmom(1NEMO)</a>
, <a href='ccdsub.1.html'>ccdsub(1NEMO)</a>
, <a href='velcube.1.html'>velcube(1NEMO)</a>
, <a href='rvstack.1.html'>rvstack(1NEMO)</a>
, <a href='image.5.html'>image(5NEMO)</a>

<p>

<p><a href='https://github.com/jbjolly/LineStacker'>https://github.com/jbjolly/LineStacker</a>
 
<p> 
<p> 
<h2><a name='sect7' href='#toc7'>Files</a></h2>
NEMO/src/image/trans/ccdzshift.c

<p> 
<h2><a name='sect8' href='#toc8'>Author</a></h2>
Peter Teuben 
<p> 
<h2><a name='sect9' href='#toc9'>Update History</a></h2>
<br>
<pre>30-Nov-20<tt> </tt>&nbsp;<tt> </tt>&nbsp;V0.1 drafted w/ example<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
14-apr-21<tt> </tt>&nbsp;<tt> </tt>&nbsp;V0.2 expanded examples<tt> </tt>&nbsp;<tt> </tt>&nbsp;PJT
</pre><p>

<hr><p>
<a name='toc'><b>Table of Contents</b></a><p>
<ul>
<li><a name='toc0' href='#sect0'>Name</a></li>
<li><a name='toc1' href='#sect1'>Synopsis</a></li>
<li><a name='toc2' href='#sect2'>Description</a></li>
<li><a name='toc3' href='#sect3'>Parameters</a></li>
<li><a name='toc4' href='#sect4'>Examples</a></li>
<li><a name='toc5' href='#sect5'>Caveat</a></li>
<li><a name='toc6' href='#sect6'>See Also</a></li>
<li><a name='toc7' href='#sect7'>Files</a></li>
<li><a name='toc8' href='#sect8'>Author</a></li>
<li><a name='toc9' href='#sect9'>Update History</a></li>
</ul>
</body>
</html>
